---
title: "Group Assignment Training SME"
author: "Nzambuli Daniel"
date: "2023-11-15"
output: html_document
---

```{r}
library(readxl)
SME_Training_Data <- read_excel("SME Training Data.xlsx")
head(SME_Training_Data)
```

# Based on Region

**Task**

1.  Comparing diff regions to see what ways they are similar & where they differ
2.  The `response variable` if they need the facility for training

***Note:*** Include binary & ordinal responses but disregard categorical

## Exploritory analysis

### Type of data in each column

```{r}
str(SME_Training_Data)
```

### Missing-ness of the data

```{r}
library(dplyr, warn.conflicts = FALSE)
library(tidyverse)
library(finalfit)
```

```{r}
missing_plot(SME_Training_Data)
```

### **Figure out the number of data points for each location in the data**

```{r}
location = SME_Training_Data$Location
min(location, na.rm = TRUE)
max(location, na.rm = TRUE)
```

#### **Convert Na values to region 10**

```{r}
SME_Training_Data$Location[is.na(SME_Training_Data$Location)] = 10
```

```{r}
location = SME_Training_Data$Location
min(location)
max(location)
```

### Re-code the data back to string

```{r}
locality = data.frame(town = location, count = rep(1, length(location)))
locality = locality %>% group_by(town) %>% summarise(count = sum(count))
locality
```

```{r}
#  'Ruaraka' = 1
#  'Embakasi' = 2
#  'Langata' = 3
#  'Starehe' = 4
#  'Mathare' = 5
#  'Kibra' = 6
#  'Dagoretti' = 7
#  'Westlands' = 8
#  'Roysambu' = 9
#  'Kasarani' = 10
#  'Kamukunji' = 11
#  'Other' = 12
locality$town = ifelse(locality$town == 1, 'Ruaraka', ifelse(
  locality$town == 2, 'Embakasi',ifelse(
    locality$town == 3, 'Langata',ifelse(
      locality$town == 4, 'Starehe',ifelse(
        locality$town == 5, 'Mathare',ifelse(
          locality$town == 6, 'Kibra',ifelse(
            locality$town == 7, 'Dagoreti',ifelse(
              locality$town == 8, 'Westlands',ifelse(
                locality$town == 9, 'Roysambu',ifelse(
                  locality$town == 10, 'other',locality$town
                  )
                )
              )
            )
          )
        )
      )
    )
  )
  )
locality
```

**Ordinal Data**

1.  Age group of Respondents `Age`
2.  Education level `Education`
3.  Region where the SME is located `Location`
4.  Business size(number of employees) `Size`
5.  Age of the business `Ageofbusiness`

**Binary Data**

1.  Gender of respondent `Gender`
2.  Facility needed `Facility`
3.  Presence of Disabled persons `DAP`

The data for `location` was grouped into `near Nairobi` and `far from Nairobi` based on ease of walking from the town to the CBD

## Far from Nairobi

Far from towns are `Ruaraka, Embakasi, Dagoretti, Roysambu, Other`

Facility `2` is No and `1` is yes encoding is done such that yes becomes `1` and no becomes `0`

```{r}
library(dplyr, warn.conflicts = FALSE)

SME_Training_Data = SME_Training_Data %>% mutate(Facility = case_when(
  Facility == 1 ~ 1,
  Facility == 2 ~ 0,
  TRUE ~ Facility
))
SME_Training_Data$Location[is.na(SME_Training_Data$Location)] = 10
```

Far from Nairobi is location `1` this means all other locations are `0`

```{r}
far_data = SME_Training_Data %>% mutate(Location = case_when(
  Location == 1~1,
  Location == 2~1,
  Location == 7~1,
  Location == 9~1,
  Location == 10 ~ 1,
  TRUE ~Location
))
far_data = far_data %>% mutate(Location = case_when(
  Location != 1~0,
  TRUE ~Location
))
```

### Drop all columns that are not Binary or Ordinal

```{r}
colnames(SME_Training_Data)
```

**Key columns**

1.  Age - 3
2.  Education - 4
3.  Location - 6
4.  Size - 7
5.  AgeofBusiness - 8
6.  DAP - 9
7.  Gender = 2
8.  Facility = 12

```{r}
far_data = far_data[, c(2, 3, 4, 6, 7, 8, 9, 12)]
colnames(far_data)
```

```{r}
far_cols = colnames(far_data)[1: 7]
far_cols
```

```{r}
far_data = far_data[far_data$Location == 1,]
```

### contingency tables

facility `1` is yes they need the facility and `0` is no they do not need it

```{r}
for(col in far_cols){
  print(col)
  print(table(facility = far_data$Facility,
              far_data[[col]]))
}
```

**Remove all values less than 5 to perform a chi-square test**

```{r}
for(col in far_cols){
  print(col)
  print(table(facility = far_data$Facility,
              far_data[[col]])[rowMeans(table(facility = far_data$Facility,
              far_data[[col]])) >= 5,
              colMeans(table(facility = far_data$Facility,
              far_data[[col]])) >= 5])
  cat("\n\n\n")
  print(paste("Chi-squred test of", col))
  print(suppressWarnings(chisq.test(table(facility = far_data$Facility,
              far_data[[col]])[rowMeans(table(facility = far_data$Facility,
              far_data[[col]])) >= 5,
              colMeans(table(facility = far_data$Facility,
              far_data[[col]])) >= 5])))
}
```

**Interpret**

`Location` is the only data that can significantly predict whether an individual needs facilities in **far**

### Logistic model

considering the data set is small there is no split to train and test cases to ensure accuracy of prediction

#### Prepare the data

```{r}
far_data = far_data[!is.na(far_data$Facility), ]
```

```{r}
library(caTools)
library(ROCR)
```

```{r}
far_model = glm(Facility~.,
                    data = far_data, family = binomial)
summary(far_model)
```

The regression model backs up the `chi squared` test that indicated none of the variables (`Gender, Age group, Education level, location of the business, age of the busioness or whether someone is disabled` can be used as a predictor for if they need the facilities or not.

### Prediction and Accuracy

```{r}
pred_far = predict(far_model)
pred_far = ifelse(pred_far> 0.5, 1, 0)
reg_tab_far = table( actual_data = far_data$Facility[1:126] , predicted = pred_far)
reg_tab_far
```

#### accuracy

```{r}
acc_far = suppressWarnings(mean(pred_far == far_data$Facility))
acc_far
```

This model is `48.82%` accurate with coefficients of regression

```{r}
odds_rat_far = exp(coef(far_model))
odds_rat_far
```

## Near Nairobi

```{r}
library(dplyr, warn.conflicts = FALSE)
near_nairobi = SME_Training_Data%>% mutate(Location = case_when(
  Location == 1~1,
  Location == 2~1,
  Location == 7~1,
  Location == 9~1,
  Location == 10 ~ 1,
  TRUE ~Location
))
near_nairobi = near_nairobi %>% mutate(Location = case_when(
  Location != 1~0,
  TRUE ~Location
))
```

```{r}
near_nairobi = near_nairobi[, c(2, 3, 4, 6, 7, 8, 9, 12)]
colnames(near_nairobi)
```

```{r}
near_nairobi = near_nairobi[near_nairobi$Location == 0,]
```

```{r}
predictor_near_nai = colnames(near_nairobi[1:7])
predictor_near_nai
```

### Create the model for near Nairobi

```{r}
for(col in predictor_near_nai){
  print(col)
  print(table(facility = near_nairobi$Facility,
              near_nairobi[[col]])[rowMeans(table(facility = near_nairobi$Facility,
              near_nairobi[[col]])) >= 5,
              colMeans(table(facility = near_nairobi$Facility,
              near_nairobi[[col]])) >= 5])
  cat("\n\n\n")
  print(paste("Chi-squred test of", col))
  print(suppressWarnings(chisq.test(table(facility = near_nairobi$Facility,
              near_nairobi[[col]])[rowMeans(table(facility = near_nairobi$Facility,
              near_nairobi[[col]])) >= 5,
              colMeans(table(facility = near_nairobi$Facility,
              near_nairobi[[col]])) >= 5])))
}
```

### model analysis

```{r}
mod_nai = glm(Facility~., data = near_nairobi)
pred_nai = predict(mod_nai)
acc_nai = suppressWarnings(mean(pred_far == far_data$Facility))
acc_nai
```

### Model summary

```{r}
summary(mod_nai)
```
